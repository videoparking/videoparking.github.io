(this["webpackJsonpfirst-blood-part-ii"]=this["webpackJsonpfirst-blood-part-ii"]||[]).push([[0],{104:function(e,t,n){},150:function(e,t,n){"use strict";n.r(t);var o=n(1),a=n(0),c=n.n(a),r=n(30),i=n.n(r),s=(n(79),n(46),n(20)),l=n(9),u=n(19),d=n.n(u),f=n(6),b=n(23),m=n(12),p=(n(81),n(82),n(32)),h=n.n(p),j=h.a.create({baseURL:"https://ib9m7jp63g.execute-api.eu-central-1.amazonaws.com/dev/"}),g=n(152),v=n(153),x=n(154),O=n(155),w=n(18),y=n.n(w),k=n(67),z=n(68),S=n(69),_=y.a.icon({iconRetinaUrl:S.a,iconUrl:k.a,shadowUrl:z.a,iconSize:[24,36],iconAnchor:[12,36]});y.a.Marker.prototype.options.icon=_;var L=console.log,T={"8f38301f7f70d7d1/1":{pos:[52.371809,5.188753],zones:{a:{polygon:[[52.37188,5.1887],[52.371822,5.18895],[52.371754,5.1889],[52.371803,5.188663]]},b:{polygon:[[52.37208,5.188689],[52.372062,5.188753],[52.371978,5.18871],[52.371993,5.188643]]}}},"e92114fcbfd5688/1":{pos:[59.9373297,30.4832178],zones:{a2:{polygon:[[59.937344,30.483425],[59.937375,30.482893],[59.937523,30.483001],[59.937492,30.483343]]},b2:{polygon:[[59.93712,30.483006],[59.93716,30.482604],[59.937375,30.482893],[59.93725,30.483076]]},c2:{polygon:[[59.937492,30.483343],[59.937523,30.483001],[59.937571,30.483087],[59.937559,30.483296]]},d2:{polygon:[[59.937101,30.483478],[59.93712,30.483006],[59.93725,30.483076],[59.937344,30.483425],[59.937135,30.483499]]}}}};function I(){return(I=Object(b.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,j.get("view?location=".concat(t));case 4:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var C=function(){var e=Object(a.useState)({stats:[],first:!0}),t=Object(m.a)(e,2),n=t[0],c=t[1],r=Object(l.f)().latLng;if(r&&r!==n.latLng){var i=r.split(",").map(parseFloat);console.log("pos:",i);var s=function(e){for(var t=Object(m.a)(e,2),n=t[0],o=t[1],a=0,c=Object.keys(T);a<c.length;a++){var r=c[a],i=Object(m.a)(T[r].pos,2),s=i[0],l=i[1];if(s-1e-4<n&&n<s+1e-4&&l-1e-4<o&&o<l+1e-4)return r}}(i),u=s?{location:s}:{};c(Object(f.a)(Object(f.a)({},n),{},{latLng:r,pos:i},u))}var d,b=function(){(function(e){return I.apply(this,arguments)})(n.location).then((function(e){if(e){L(e);var t=e.duration?e.duration:60,o=e.frameTime,a=Object(f.a)(Object(f.a)({},n),{},{first:!1,duration:t,frameTime:o,stats:e.stats||[]});console.log(a),c(a),document.title=e.message+", parking at ".concat(T[n.location].pos)}})).catch((function(e){console.log(e);var t=n.retries?n.retries+1:0;c(Object(f.a)(Object(f.a)({},n),{},{first:!1,duration:30,retries:t,stats:[]})),document.title="Retrying (".concat(t,")")+(n.frameTime?" from ".concat(n.frameTime," ..."):"...")}))};return Object(a.useEffect)((function(){var e=n.first?0:n.duration;console.log("Timeout till renew:",e);var t=setTimeout(b,1e3*e);return function(){console.log("Stopping renewal of MapView"),clearTimeout(t)}})),Object(o.jsxs)(x.a,{center:n.pos,zoom:19,scrollWheelZoom:!1,maxZoom:20,children:[Object(o.jsx)(O.a,{url:"https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token={accessToken}",attribution:'<a href="http://videoparking.live/copyright">VideoParking.live</a> | Map data \xa9 <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery \xa9 <a href="https://www.mapbox.com/">Mapbox</a>',accessToken:"pk.eyJ1IjoidmlkZW9wYXJraW5nIiwiYSI6ImNraTZqa2QycTBmY2EzMG1xZ2R4eGpqaGMifQ.LG9VLK74nBfMJsoxpLQhxg",maxZoom:20}),(d=n.stats,d.map((function(e){var t=e.location+"/"+e.camera,n=T[t];if(n){L(n);var a=n.zones[e.zone];if(a){L(a);var c=a.polygon[0];L(c);var r=parseInt(e.max_detected_cars),i=parseInt(e.last_detected_cars)/r;L(i);var s={fillColor:"blue",color:"blue"};i<.5?s={fillColor:"green",color:"green"}:i<.8?s={fillColor:"red",color:"red"}:i<1.1&&(s={fillColor:"black",color:"black"});var l=new Date(e.time.replace(" ","T")+"Z"),u=e.period_for_max.replace(/\:[^:]+$/,"").replace(" "," days ");return Object(o.jsx)("div",{children:Object(o.jsx)(g.a,{pathOptions:s,positions:a.polygon,children:Object(o.jsxs)(v.a,{children:[Object(o.jsxs)("h1",{children:[(100*i).toLocaleString(void 0,{maximumFractionDigits:0})+"%"," full"]}),Object(o.jsxs)("strong",{children:[e.max_detected_cars," max"]})," over ",u," ",Object(o.jsx)("br",{}),Object(o.jsxs)("strong",{children:[e.last_detected_cars," cars parked"]})," at ",l.toLocaleString()," ",Object(o.jsx)("br",{})]})})},t+"-"+e.zone)}return L(e.zone),null}return L(t),null})))]})},E=(n(104),n(33)),M=n(34),R=n(36),D=n(35),U=n(7),W=function(e){Object(R.a)(n,e);var t=Object(D.a)(n);function n(){var e;Object(E.a)(this,n);for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).state={image:null,error:void 0},e.handleLoad=function(){e.setState({image:e.image,error:void 0}),e.props.onLoadImage&&e.props.onLoadImage(e.image)},e.handleError=function(t){e.setState({error:"Loading..."})},e}return Object(M.a)(n,[{key:"componentDidMount",value:function(){this.loadImage()}},{key:"componentDidUpdate",value:function(e){e.src!==this.props.src&&this.loadImage()}},{key:"componentWillUnmount",value:function(){this.image.removeEventListener("load",this.handleLoad)}},{key:"loadImage",value:function(){this.props.src?(this.image=new window.Image,this.image.src=this.props.src,this.image.addEventListener("load",this.handleLoad),this.image.addEventListener("error",this.handleError)):this.image=void 0}},{key:"render",value:function(){var e=this;return void 0!==this.state.error?Object(o.jsx)(U.Text,{text:this.state.error,fontSize:20,fill:"red"}):Object(o.jsx)(U.Image,{x:0,y:0,image:this.state.image,scaleX:this.props.scale,scaleY:this.props.scale,ref:function(t){e.imageNode=t}})}}]),n}(c.a.Component),G=n(73),B=n(72),P=n.n(B),A=h.a.create({baseURL:"https://raw.githubusercontent.com/videoparking/zones/master/v1/"});function N(){return(N=Object(b.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=8;break}return e.next=3,A.get("".concat(t,"/zones-v1.json"));case 3:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 8:return e.abrupt("return",void 0);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function V(e){var t={};return e.map((function(e){return t[e.zone]=e})),t}var Z=function(e){var t=Object(a.useState)({zones:[],stats:V(e.stats)}),n=Object(m.a)(t,2),c=n[0],r=n[1];Object(a.useEffect)((function(){r(Object(f.a)(Object(f.a)({},c),{},{stats:V(e.stats)}))}),[e.stats]);var i=function(){(function(e){return N.apply(this,arguments)})(e.location).then((function(t){console.log(t),r({zones:t.zones,stats:V(e.stats)})})).catch((function(e){console.log("ERROR:",e),r({zones:[]})}))};Object(a.useEffect)((function(){i()}),[e.location]);var s=function(t){return t*e.scale},l=function(t){return t/e.scale},u=function(e){return e.polygon.map((function(e){var t=Object(m.a)(e,2),n=t[0],o=t[1];return[s(n),s(o)]})).flat()},d=function(e){if(c.stats){var t=c.stats[e];return t?"".concat(e," ").concat(t.last_detected_cars,"/").concat(t.max_detected_cars):e}},b=function(e){for(var t=e.polygon,n=[],o=0;o<t.length;o++){var a=Object(m.a)(t[o],2),c=a[0],r=a[1];n[o]={x:c,y:r,i:o}}return console.log("ppoints:",n),n},p=function(e,t,n,o){for(var a=[],r=0;r<c.zones.length;r++){var i=c.zones[r];i.name===e&&(i.polygon[t]=[n,o],i.modified=!0),a[r]=i}return a},h=function(e,t){for(var n=[],o=0;o<c.zones.length;o++){var a=c.zones[o];a.name===e&&(a.polygon.splice(t,0,a.polygon[t]),a.modified=!0),n[o]=a}return n},j=function(){var e,t=100,n=100,o=(e=c.zones.map((function(e){return e.name})),String.fromCharCode("a".charCodeAt(0)+e.length)),a={name:o,polygon:[[t,n],[600,n],[600,600],[t,600]],modified:!0};console.log("Adding new zone",o),r(Object(f.a)(Object(f.a)({},c),{},{zones:[].concat(Object(G.a)(c.zones),[a])}))},g=function(e,t){!function(e,t){var n=window.URL||window.webkitURL||window,o=new Blob([t]);if("msSaveBlob"in navigator)navigator.msSaveBlob(o,e);else{if(!("download"in HTMLAnchorElement.prototype))throw new Error("Neither a[download] nor msSaveBlob is available");var a=document.createElementNS("http://www.w3.org/1999/xhtml","a");a.href=n.createObjectURL(o),a.download=e,function(e){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}(a)}}(e,t)};return Object(o.jsxs)(U.Group,{children:[c.zones.map((function(t){return Object(o.jsxs)(U.Group,{x:0,y:0,children:[Object(o.jsx)(U.Text,{text:d(t.name),x:3+t.polygon[0][0]*e.scale,y:t.polygon[0][1]*e.scale,fontSize:10,fill:e.color}),Object(o.jsx)(U.Line,{points:u(t),stroke:t.modified?e.modifiedColor:e.color,strokeWidth:1,closed:!0}),b(t).map((function(n){var a=n.x,i=n.y,u=n.i;return Object(o.jsx)(U.Circle,{x:s(a),y:s(i),radius:5,fill:t.modified?e.modifiedColor:e.color,draggable:!0,onDragStart:function(e){console.log(">>",e);var n=e.evt.shiftKey?{zones:h(t.name,u)}:{};r(Object(f.a)(Object(f.a)({},c),{},{isDragging:!0},n))},onDragMove:function(e){0===e.evt.movementX&&0===e.evt.movementY||(console.log(">>>",e),r(Object(f.a)(Object(f.a)({},c),{},{isDragging:!0,zones:p(t.name,u,l(e.target.x()),l(e.target.y()))})))},onDragEnd:function(e){console.log(">>>>",e),r(Object(f.a)(Object(f.a)({},c),{},{isDragging:!1,zones:p(t.name,u,l(e.target.x()),l(e.target.y()))}))}},t.name+"-p-"+u)}))]},t.name)})),Object(o.jsx)(P.a,{handleKeys:["e","a"],onKeyEvent:function(t,n){return function(t){console.log("key:",t),"e"===t?g("".concat(e.location,"/zones-v1.json"),JSON.stringify({base_resolution:e.baseResolution,zones:c.zones},null,2)):"a"===t&&j()}(t)}})]})},J=function(e){Object(R.a)(n,e);var t=Object(D.a)(n);function n(){var e;Object(E.a)(this,n);for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).state={detections:e.props.detections.map((function(t){return e.norm(t)}))},e}return Object(M.a)(n,[{key:"componentDidMount",value:function(){}},{key:"componentDidUpdate",value:function(e){var t=this;if(e.detections!==this.props.detections){var n=this.props.detections.map((function(e){return t.norm(e)}));this.setState({detections:n})}}},{key:"componentWillUnmount",value:function(){}},{key:"norm",value:function(e){return{object:e.object,confidence:parseFloat(e.measure_value),bbox:{x:parseInt(e.att_x)+parseInt(e.bbox_x)-parseInt(e.bbox_w)/2,y:parseInt(e.att_y)+parseInt(e.bbox_y)-parseInt(e.bbox_h)/2,width:parseInt(e.bbox_w),height:parseInt(e.bbox_h)}}}},{key:"scaled",value:function(e){return e*this.props.scale}},{key:"render",value:function(){var e=this;return this.state.detections.map((function(t){return Object(o.jsxs)(U.Group,{x:e.scaled(t.bbox.x),y:e.scaled(t.bbox.y),children:[Object(o.jsx)(U.Text,{text:t.object+" "+t.confidence.toFixed(2),x:3,fontSize:10,fill:e.props.color}),Object(o.jsx)(U.Rect,{width:e.scaled(t.bbox.width),height:e.scaled(t.bbox.height),stroke:e.props.color,strokeWidth:1})]},t.confidence)}))}}]),n}(c.a.Component),Y=console.log;function K(){return(K=Object(b.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j.get("view?location=".concat(t,"&image=yes&detections=yes"));case 2:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function F(){return Math.max(document.documentElement.clientWidth||0,window.innerWidth||0)}function H(){return Math.max(document.documentElement.clientHeight||0,window.innerHeight||0)}function Q(e,t,n,o){if(e&&t&&n&&o){var a=e/n,c=t/o;return Math.min(a,c)}return.25}var X=function(){var e=Object(a.useState)({picSrc:void 0,firstPic:!0,vw:F(),vh:H(),scale:Q(F(),H()),detections:[],stats:[]}),t=Object(m.a)(e,2),n=t[0],c=t[1],r=Object(l.f)(),i=r.location,s=r.camera,u=function(e,t){var n=function(e){var t=e/60;return Math.max(0,Math.min(100,100-25*t))}(((new Date).getTime()-new Date(t).getTime())/1e3-65);return{backgroundImage:"url(".concat(e,")"),backgroundColor:"#282c34",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundAttachment:"fixed",backgroundPosition:"center",filter:"blur(".concat(0,"px) saturate(").concat(n,"%)")}},d=function(){(function(e){return K.apply(this,arguments)})(i+"/"+s).then((function(e){Y(e);var t=e.duration?e.duration:60,o=e.image.url,a=e.frameTime,r=u(o,a),l=Object(f.a)(Object(f.a)({},n),{},{picSrc:o,firstPic:!1,duration:t,frameTime:a,style:r,detections:e.detections||[],stats:e.stats||[]});c(l),document.title=e.message+", parking at ".concat(i,"/").concat(s," ").concat(new Date(a))})).catch((function(e){console.log(e);var t=u(n.picSrc,n.frameTime),o=n.retries?n.retries+1:0;c(Object(f.a)(Object(f.a)({},n),{},{picSrc:n.picSrc,firstPic:!1,duration:30,style:t,retries:o,detections:[],stats:[]})),document.title="Retrying (".concat(o,")")+(n.frameTime?" from ".concat(n.frameTime," ..."):"...")}))};return i===n.location&&s===n.camera||c(Object(f.a)(Object(f.a)({},n),{},{firstPic:!0,location:i,camera:s})),Object(a.useEffect)((function(){var e=n.firstPic?0:n.duration;console.log("Timeout till renew:",e);var t=setTimeout(d,1e3*e);return function(){console.log("Stopping renewal of CamView"),clearTimeout(t)}})),Object(o.jsx)("div",{className:"CamView",children:Object(o.jsx)("div",{className:"CamView-header",children:Object(o.jsxs)(U.Stage,{width:n.vw,height:n.vh,style:{backgroundColor:"dimgray"},children:[Object(o.jsx)(U.Layer,{children:Object(o.jsx)(W,{src:n.picSrc,scale:n.scale,onLoadImage:function(e){return function(e){var t=F(),o=H(),a=e?e.width:n.iw,r=e?e.height:n.ih,i=Q(t,o,a,r);if(a!==n.iw||r!==n.ih||t!==n.vw||o!==n.vh||i!==n.scale){var s={vw:t,vh:o,iw:a,ih:r,scale:i};console.log("[!] New state changes:",s),c(Object(f.a)(Object(f.a)({},n),s))}}(e)}})}),Object(o.jsx)(U.Layer,{children:Object(o.jsx)(Z,{location:i+"/"+s,stats:n.stats,scale:n.scale,color:"magenta",modifiedColor:"red",baseResolution:[n.iw,n.ih]})}),Object(o.jsx)(U.Layer,{children:Object(o.jsx)(J,{detections:n.detections,scale:n.scale,color:"yellow"})}),Object(o.jsxs)(U.Layer,{children:[Object(o.jsx)(U.Group,{x:n.vw-200,y:3,children:Object(o.jsx)(U.Text,{text:"Info:\n  location: ".concat(i,"\n  camera: ").concat(s,"\n  frame time: ").concat(n.frameTime,"\n  detections: ").concat(n.detections.length,"\n  zones:\n    ")+n.stats.map((function(e){return"".concat(e.zone,": ").concat(e.last_detected_cars,"/").concat(e.max_detected_cars," [max of ").concat(e.period_for_max,"]")})).join("\n    "),fontSize:10,fill:"magenta"})}),Object(o.jsx)(U.Group,{x:n.vw-180,y:n.vh-120,children:Object(o.jsx)(U.Text,{text:"Config:\n  screen: ".concat(n.vw,"x").concat(n.vh,"\n  scale: ").concat(n.scale,"\n\nKeys:\n  'e': export zones\n  'a': add new zone\n\nHelp:\n  - Move zone edge points with mouse.\n    Use shift to clone edges.\n"),fontSize:10,fill:"black"})})]})]})})})};var q=function(){return Object(o.jsx)("div",{children:Object(o.jsxs)("center",{children:[Object(o.jsx)("h1",{children:"VideoParking"}),Object(o.jsx)("h2",{children:Object(o.jsx)("i",{children:"on a live map"})}),Object(o.jsxs)("h3",{children:["Get your link on telegram ",Object(o.jsx)("a",{href:"https://t.me/videoparkinglive",children:"t.me/videoparkinglive"})]})]})})};var $=function(){return Object(o.jsx)("div",{children:Object(o.jsx)(s.a,{children:Object(o.jsxs)(l.c,{children:[Object(o.jsx)(l.a,{path:"/nav",children:Object(o.jsxs)("div",{children:[Object(o.jsx)("h1",{children:"VideoParking"}),Object(o.jsx)("nav",{children:Object(o.jsxs)("ul",{children:[Object(o.jsxs)("li",{children:["a07345b2737af5f/1 > ",Object(o.jsx)(s.b,{to:"/cam/a07345b2737af5f/1",children:"Camera"})]}),Object(o.jsxs)("li",{children:["8f38301f7f70d7d1/1 > ",Object(o.jsx)(s.b,{to:"/cam/8f38301f7f70d7d1/1",children:"Camera"})," > ",Object(o.jsx)(s.b,{to:"/52.371809,5.188753",children:"Map"})]}),Object(o.jsxs)("li",{children:["e92114fcbfd5688/1 > ",Object(o.jsx)(s.b,{to:"/cam/e92114fcbfd5688/1",children:"Camera"})," > ",Object(o.jsx)(s.b,{to:"/59.9373297,30.4832178",children:"Map"})]})]})})]})}),Object(o.jsx)(l.a,{path:"/cam/:location/:camera/:zone",children:Object(o.jsx)(X,{})}),Object(o.jsx)(l.a,{path:"/cam/:location/:camera",children:Object(o.jsx)(X,{})}),Object(o.jsx)(l.a,{path:"/:latLng",children:Object(o.jsx)(C,{})}),Object(o.jsx)(l.a,{path:"/",children:Object(o.jsx)(q,{})})]})})})};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(Object(o.jsx)(c.a.StrictMode,{children:Object(o.jsx)($,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},46:function(e,t,n){},79:function(e,t,n){},82:function(e,t,n){}},[[150,1,2]]]);
//# sourceMappingURL=main.0ab5fa5e.chunk.js.map