(this["webpackJsonpfirst-blood-part-ii"]=this["webpackJsonpfirst-blood-part-ii"]||[]).push([[0],{100:function(e,t,n){},146:function(e,t,n){"use strict";n.r(t);var a=n(1),o=n(0),c=n.n(o),r=n(34),i=n.n(r),s=(n(74),n(75),n(21)),l=n(8),u=n(18),d=n.n(u),p=n(6),f=n(19),h=n(23),b=(n(77),n(78),n(35)),m=n.n(b),j=m.a.create({baseURL:"https://ib9m7jp63g.execute-api.eu-central-1.amazonaws.com/dev/"}),v=n(148),g=n(149),x=n(150),O=n(151),y=n(152),w=n(13),k=n.n(w),S=n(65),_=n(66),z=n(67),T=k.a.icon({iconRetinaUrl:z.a,iconUrl:S.a,shadowUrl:_.a,iconSize:[24,36],iconAnchor:[12,36]});k.a.Marker.prototype.options.icon=T;var I=console.log,L={"8f38301f7f70d7d1/1":{pos:[52.371809,5.188753],zones:{a:{polygon:[[52.37188,5.1887],[52.371822,5.18895],[52.371754,5.1889],[52.371803,5.188663]]},b:{polygon:[[52.37208,5.188689],[52.372062,5.188753],[52.371978,5.18871],[52.371993,5.188643]]}}}};function C(){return(C=Object(h.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,j.get("view?location=".concat(t));case 4:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var M=function(){var e=Object(o.useState)({stats:[],first:!0,location:"8f38301f7f70d7d1/1"}),t=Object(f.a)(e,2),n=t[0],c=t[1],r=Object(l.f)().latLng;if(r&&r!==n.latLng){var i=r.split(",").map(parseFloat);console.log("pos:",i),c(Object(p.a)(Object(p.a)({},n),{},{latLng:r,pos:i}))}var u,d=function(){(function(e){return C.apply(this,arguments)})(n.location).then((function(e){if(e){I(e);var t=e.duration?e.duration:60,a=e.frameTime,o=Object(p.a)(Object(p.a)({},n),{},{first:!1,duration:t,frameTime:a,stats:e.stats||[]});console.log(o),c(o),document.title=e.message+", parking at ".concat(n.location," ").concat(new Date(a))}})).catch((function(e){console.log(e);var t=n.retries?n.retries+1:0;c(Object(p.a)(Object(p.a)({},n),{},{first:!1,duration:30,retries:t,stats:[]})),document.title="Retrying (".concat(t,")")+(n.frameTime?" from ".concat(n.frameTime," ..."):"...")}))};return Object(o.useEffect)((function(){var e=n.first?0:n.duration;console.log("Timeout till renew:",e);var t=setTimeout(d,1e3*e);return function(){console.log("Stopping renewal of MapView"),clearTimeout(t)}})),Object(a.jsxs)(O.a,{center:n.pos||[52.371809,5.188753],zoom:18,scrollWheelZoom:!1,children:[Object(a.jsx)(y.a,{attribution:'<a href="http://videoparking.live/copyright">VideoParking.live</a> | \xa9 <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),(u=n.stats,u.map((function(e){var t=e.location+"/"+e.camera,n=L[t];if(n){I(n);var o=n.zones[e.zone];if(o){I(o);var c=o.polygon[0];I(c);var r=parseInt(e.max_detected_cars),i=parseInt(e.last_detected_cars)/r;I(i);var l={fillColor:"blue",color:"blue"};return i<.5?l={fillColor:"green",color:"green"}:i<.8?l={fillColor:"red",color:"red"}:i<1.1&&(l={fillColor:"black",color:"black"}),Object(a.jsxs)("div",{children:[Object(a.jsx)(v.a,{position:c}),Object(a.jsx)(g.a,{pathOptions:l,positions:o.polygon,children:Object(a.jsxs)(x.a,{children:[e.last_detected_cars," cars parked by ",e.time," ",Object(a.jsx)("br",{}),e.max_detected_cars," max (for period of ",e.period_for_max,") ",Object(a.jsx)("br",{}),(100*i).toLocaleString(void 0,{maximumFractionDigits:0})+"%"," filled ",Object(a.jsx)("br",{}),Object(a.jsx)(s.b,{to:"/cam/"+e.location+"/"+e.camera+"/"+e.zone,children:"view"})]})})]},t+"-"+e.zone)}return I(e.zone),null}return I(t),null})))]})},P=(n(100),n(25)),D=n(26),E=n(28),U=n(27),R=n(9),W=function(e){Object(E.a)(n,e);var t=Object(U.a)(n);function n(){var e;Object(P.a)(this,n);for(var a=arguments.length,o=new Array(a),c=0;c<a;c++)o[c]=arguments[c];return(e=t.call.apply(t,[this].concat(o))).state={image:null,error:void 0},e.handleLoad=function(){e.setState({image:e.image,error:void 0}),e.props.onLoadImage&&e.props.onLoadImage(e.image)},e.handleError=function(t){e.setState({error:"Loading..."})},e}return Object(D.a)(n,[{key:"componentDidMount",value:function(){this.loadImage()}},{key:"componentDidUpdate",value:function(e){e.src!==this.props.src&&this.loadImage()}},{key:"componentWillUnmount",value:function(){this.image.removeEventListener("load",this.handleLoad)}},{key:"loadImage",value:function(){this.props.src?(this.image=new window.Image,this.image.src=this.props.src,this.image.addEventListener("load",this.handleLoad),this.image.addEventListener("error",this.handleError)):this.image=void 0}},{key:"render",value:function(){var e=this;return void 0!==this.state.error?Object(a.jsx)(R.Text,{text:this.state.error,fontSize:20,fill:"red"}):Object(a.jsx)(R.Image,{x:0,y:0,image:this.state.image,scaleX:this.props.scale,scaleY:this.props.scale,ref:function(t){e.imageNode=t}})}}]),n}(c.a.Component),V=m.a.create({baseURL:"/zones-data/v1/"}),A=console.log;function F(){return(F=Object(h.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=8;break}return e.next=3,V.get("".concat(t,"/zones-v1.json"));case 3:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 8:return e.abrupt("return",void 0);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function G(e){var t={};return e.map((function(e){return t[e.zone]=e})),t}var N=function(e){Object(E.a)(n,e);var t=Object(U.a)(n);function n(){var e;Object(P.a)(this,n);for(var a=arguments.length,o=new Array(a),c=0;c<a;c++)o[c]=arguments[c];return(e=t.call.apply(t,[this].concat(o))).state={zones:[],stats:G(e.props.stats)},e}return Object(D.a)(n,[{key:"componentDidMount",value:function(){this.loadZones()}},{key:"componentDidUpdate",value:function(e){e.location!==this.props.location?this.loadZones():e.stats!==this.props.stats&&this.setState(Object(p.a)(Object(p.a)({},this.state),{},{stats:G(this.props.stats)}))}},{key:"componentWillUnmount",value:function(){}},{key:"loadZones",value:function(){var e=this;(function(e){return F.apply(this,arguments)})(this.props.location).then((function(t){A(t),e.setState({zones:t.zones,stats:G(e.props.stats)})})).catch((function(t){console.log("ERROR:",t),e.setState({zones:[]})}))}},{key:"drawPolygon",value:function(e){var t=this,n=function(e){return e*t.props.scale};return function(t){if(e){var a=e.polygon;t.beginPath(),t.moveTo(n(a[0][0]),n(a[0][1]));for(var o=1;o<a.length;o++)t.lineTo(n(a[o][0]),n(a[o][1]));t.closePath(),t.fillStrokeShape(this)}else console.log("no zones to preview")}}},{key:"info",value:function(e){if(this.state.stats){var t=this.state.stats[e];return t?"".concat(e," ").concat(t.last_detected_cars,"/").concat(t.max_detected_cars):e}}},{key:"render",value:function(){var e=this;return this.state.zones.map((function(t){return Object(a.jsxs)(R.Group,{x:0,y:0,children:[Object(a.jsx)(R.Text,{text:e.info(t.name),x:3+t.polygon[0][0]*e.props.scale,y:t.polygon[0][1]*e.props.scale,fontSize:10,fill:e.props.color}),Object(a.jsx)(R.Shape,{stroke:e.props.color,strokeWidth:1,sceneFunc:e.drawPolygon(t)})]},t.name)}))}}]),n}(c.a.Component),Z=function(e){Object(E.a)(n,e);var t=Object(U.a)(n);function n(){var e;Object(P.a)(this,n);for(var a=arguments.length,o=new Array(a),c=0;c<a;c++)o[c]=arguments[c];return(e=t.call.apply(t,[this].concat(o))).state={detections:e.props.detections.map((function(t){return e.norm(t)}))},e}return Object(D.a)(n,[{key:"componentDidMount",value:function(){}},{key:"componentDidUpdate",value:function(e){var t=this;if(e.detections!==this.props.detections){var n=this.props.detections.map((function(e){return t.norm(e)}));this.setState({detections:n})}}},{key:"componentWillUnmount",value:function(){}},{key:"norm",value:function(e){return{object:e.object,confidence:parseFloat(e.measure_value),bbox:{x:parseInt(e.att_x)+parseInt(e.bbox_x)-parseInt(e.bbox_w)/2,y:parseInt(e.att_y)+parseInt(e.bbox_y)-parseInt(e.bbox_h)/2,width:parseInt(e.bbox_w),height:parseInt(e.bbox_h)}}}},{key:"scaled",value:function(e){return e*this.props.scale}},{key:"render",value:function(){var e=this;return this.state.detections.map((function(t){return Object(a.jsxs)(R.Group,{x:e.scaled(t.bbox.x),y:e.scaled(t.bbox.y),children:[Object(a.jsx)(R.Text,{text:t.object+" "+t.confidence.toFixed(2),x:3,fontSize:10,fill:e.props.color}),Object(a.jsx)(R.Rect,{width:e.scaled(t.bbox.width),height:e.scaled(t.bbox.height),stroke:e.props.color,strokeWidth:1})]},t.confidence)}))}}]),n}(c.a.Component),B=console.log;function H(){return(H=Object(h.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j.get("view?location=".concat(t,"&image=yes&detections=yes"));case 2:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function J(){return Math.max(document.documentElement.clientWidth||0,window.innerWidth||0)}function X(){return Math.max(document.documentElement.clientHeight||0,window.innerHeight||0)}function Y(e,t,n,a){if(e&&t&&n&&a){var o=e/n,c=t/a;return Math.min(o,c)}return.25}var $=function(){var e=Object(o.useState)({picSrc:void 0,firstPic:!0,vw:J(),vh:X(),scale:Y(J(),X()),detections:[],stats:[]}),t=Object(f.a)(e,2),n=t[0],c=t[1],r=Object(l.f)(),i=r.location,s=r.camera,u=function(e,t){var n=function(e){var t=e/60;return Math.max(0,Math.min(100,100-25*t))}(((new Date).getTime()-new Date(t).getTime())/1e3-65);return{backgroundImage:"url(".concat(e,")"),backgroundColor:"#282c34",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundAttachment:"fixed",backgroundPosition:"center",filter:"blur(".concat(0,"px) saturate(").concat(n,"%)")}},d=function(){(function(e){return H.apply(this,arguments)})(i+"/"+s).then((function(e){B(e);var t=e.duration?e.duration:60,a=e.image.url,o=e.frameTime,r=u(a,o),l=Object(p.a)(Object(p.a)({},n),{},{picSrc:a,firstPic:!1,duration:t,frameTime:o,style:r,detections:e.detections||[],stats:e.stats||[]});c(l),document.title=e.message+", parking at ".concat(i,"/").concat(s," ").concat(new Date(o))})).catch((function(e){console.log(e);var t=u(n.picSrc,n.frameTime),a=n.retries?n.retries+1:0;c(Object(p.a)(Object(p.a)({},n),{},{picSrc:n.picSrc,firstPic:!1,duration:30,style:t,retries:a,detections:[],stats:[]})),document.title="Retrying (".concat(a,")")+(n.frameTime?" from ".concat(n.frameTime," ..."):"...")}))};return i===n.location&&s===n.camera||c(Object(p.a)(Object(p.a)({},n),{},{firstPic:!0,location:i,camera:s})),Object(o.useEffect)((function(){var e=n.firstPic?0:n.duration;console.log("Timeout till renew:",e);var t=setTimeout(d,1e3*e);return function(){console.log("Stopping renewal of CamView"),clearTimeout(t)}})),Object(a.jsx)("div",{className:"CamView",children:Object(a.jsx)("div",{className:"CamView-header",children:Object(a.jsxs)(R.Stage,{width:n.vw,height:n.vh,style:{backgroundColor:"dimgray"},children:[Object(a.jsx)(R.Layer,{children:Object(a.jsx)(W,{src:n.picSrc,scale:n.scale,onLoadImage:function(e){return function(e){var t=J(),a=X(),o=e?e.width:n.iw,r=e?e.height:n.ih,i=Y(t,a,o,r);if(o!==n.iw||r!==n.ih||t!==n.vw||a!==n.vh||i!==n.scale){var s={vw:t,vh:a,iw:o,ih:r,scale:i};console.log("[!] New state changes:",s),c(Object(p.a)(Object(p.a)({},n),s))}}(e)}})}),Object(a.jsx)(R.Layer,{children:Object(a.jsx)(N,{location:i+"/"+s,stats:n.stats,scale:n.scale,color:"magenta"})}),Object(a.jsx)(R.Layer,{children:Object(a.jsx)(Z,{detections:n.detections,scale:n.scale,color:"yellow"})}),Object(a.jsxs)(R.Layer,{children:[Object(a.jsx)(R.Group,{x:n.vw-200,y:3,children:Object(a.jsx)(R.Text,{text:"Info:\n  location: ".concat(i,"\n  camera: ").concat(s,"\n  frame time: ").concat(n.frameTime,"\n  detections: ").concat(n.detections.length,"\n  zones:\n    ")+n.stats.map((function(e){return"".concat(e.zone,": ").concat(e.last_detected_cars,"/").concat(e.max_detected_cars," [max of ").concat(e.period_for_max,"]")})).join("\n    "),fontSize:10,fill:"magenta"})}),Object(a.jsx)(R.Group,{x:n.vw-180,y:n.vh-30,children:Object(a.jsx)(R.Text,{text:"Config:\n  screen: ".concat(n.vw,"x").concat(n.vh,"\n  scale: ").concat(n.scale,"\n"),fontSize:10,fill:"black"})})]})]})})})};var q=function(){return Object(a.jsxs)("div",{children:[Object(a.jsx)("h1",{children:"VideoParking"}),Object(a.jsxs)(s.a,{children:[Object(a.jsx)("nav",{children:Object(a.jsxs)("ul",{children:[Object(a.jsx)("li",{children:Object(a.jsx)(s.b,{to:"/map/52.371809,5.188753",children:"Map"})}),Object(a.jsx)("li",{children:Object(a.jsx)(s.b,{to:"/cam/8f38301f7f70d7d1/1",children:"Camera 8f38301f7f70d7d1/1"})}),Object(a.jsx)("li",{children:Object(a.jsx)(s.b,{to:"/cam/a07345b2737af5f/1",children:"Camera a07345b2737af5f/1"})})]})}),Object(a.jsxs)(l.c,{children:[Object(a.jsx)(l.a,{path:"/map/:latLng",children:Object(a.jsx)(M,{})}),Object(a.jsx)(l.a,{path:"/cam/:location/:camera/:zone",children:Object(a.jsx)($,{})}),Object(a.jsx)(l.a,{path:"/cam/:location/:camera",children:Object(a.jsx)($,{})}),Object(a.jsx)(l.a,{path:"/",children:Object(a.jsx)(M,{})})]})]})]})};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(Object(a.jsx)(c.a.StrictMode,{children:Object(a.jsx)(q,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},74:function(e,t,n){},75:function(e,t,n){},78:function(e,t,n){}},[[146,1,2]]]);
//# sourceMappingURL=main.57cbcfaa.chunk.js.map