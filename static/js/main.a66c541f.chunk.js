(this["webpackJsonpfirst-blood-part-ii"]=this["webpackJsonpfirst-blood-part-ii"]||[]).push([[0],{102:function(e,t,n){},147:function(e,t,n){"use strict";n.r(t);var o=n(1),a=n(0),c=n.n(a),r=n(30),i=n.n(r),s=(n(76),n(77),n(21)),l=n(9),u=n(19),d=n.n(u),f=n(6),p=n(17),b=n(24),m=(n(79),n(80),n(31)),h=n.n(m),j=h.a.create({baseURL:"https://ib9m7jp63g.execute-api.eu-central-1.amazonaws.com/dev/"}),g=n(149),v=n(150),x=n(151),O=n(152),w=n(153),y=n(13),k=n.n(y),z=n(66),S=n(67),_=n(68),L=k.a.icon({iconRetinaUrl:_.a,iconUrl:z.a,shadowUrl:S.a,iconSize:[24,36],iconAnchor:[12,36]});k.a.Marker.prototype.options.icon=L;var T=console.log,E={"8f38301f7f70d7d1/1":{pos:[52.371809,5.188753],zones:{a:{polygon:[[52.37188,5.1887],[52.371822,5.18895],[52.371754,5.1889],[52.371803,5.188663]]},b:{polygon:[[52.37208,5.188689],[52.372062,5.188753],[52.371978,5.18871],[52.371993,5.188643]]}}}};function I(){return(I=Object(b.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,j.get("view?location=".concat(t));case 4:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var C=function(){var e=Object(a.useState)({stats:[],first:!0,location:"8f38301f7f70d7d1/1"}),t=Object(p.a)(e,2),n=t[0],c=t[1],r=Object(l.f)().latLng;if(r&&r!==n.latLng){var i=r.split(",").map(parseFloat);console.log("pos:",i),c(Object(f.a)(Object(f.a)({},n),{},{latLng:r,pos:i}))}var u,d=function(){(function(e){return I.apply(this,arguments)})(n.location).then((function(e){if(e){T(e);var t=e.duration?e.duration:60,o=e.frameTime,a=Object(f.a)(Object(f.a)({},n),{},{first:!1,duration:t,frameTime:o,stats:e.stats||[]});console.log(a),c(a),document.title=e.message+", parking at ".concat(n.location," ").concat(new Date(o))}})).catch((function(e){console.log(e);var t=n.retries?n.retries+1:0;c(Object(f.a)(Object(f.a)({},n),{},{first:!1,duration:30,retries:t,stats:[]})),document.title="Retrying (".concat(t,")")+(n.frameTime?" from ".concat(n.frameTime," ..."):"...")}))};return Object(a.useEffect)((function(){var e=n.first?0:n.duration;console.log("Timeout till renew:",e);var t=setTimeout(d,1e3*e);return function(){console.log("Stopping renewal of MapView"),clearTimeout(t)}})),Object(o.jsxs)(O.a,{center:n.pos||[52.371809,5.188753],zoom:18,scrollWheelZoom:!1,children:[Object(o.jsx)(w.a,{attribution:'<a href="http://videoparking.live/copyright">VideoParking.live</a> | \xa9 <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),(u=n.stats,u.map((function(e){var t=e.location+"/"+e.camera,n=E[t];if(n){T(n);var a=n.zones[e.zone];if(a){T(a);var c=a.polygon[0];T(c);var r=parseInt(e.max_detected_cars),i=parseInt(e.last_detected_cars)/r;T(i);var l={fillColor:"blue",color:"blue"};return i<.5?l={fillColor:"green",color:"green"}:i<.8?l={fillColor:"red",color:"red"}:i<1.1&&(l={fillColor:"black",color:"black"}),Object(o.jsxs)("div",{children:[Object(o.jsx)(g.a,{position:c}),Object(o.jsx)(v.a,{pathOptions:l,positions:a.polygon,children:Object(o.jsxs)(x.a,{children:[e.last_detected_cars," cars parked by ",e.time," ",Object(o.jsx)("br",{}),e.max_detected_cars," max (for period of ",e.period_for_max,") ",Object(o.jsx)("br",{}),(100*i).toLocaleString(void 0,{maximumFractionDigits:0})+"%"," filled ",Object(o.jsx)("br",{}),Object(o.jsx)(s.b,{to:"/cam/"+e.location+"/"+e.camera+"/"+e.zone,children:"view"})]})})]},t+"-"+e.zone)}return T(e.zone),null}return T(t),null})))]})},M=(n(102),n(32)),D=n(33),R=n(35),U=n(34),W=n(7),P=function(e){Object(R.a)(n,e);var t=Object(U.a)(n);function n(){var e;Object(M.a)(this,n);for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).state={image:null,error:void 0},e.handleLoad=function(){e.setState({image:e.image,error:void 0}),e.props.onLoadImage&&e.props.onLoadImage(e.image)},e.handleError=function(t){e.setState({error:"Loading..."})},e}return Object(D.a)(n,[{key:"componentDidMount",value:function(){this.loadImage()}},{key:"componentDidUpdate",value:function(e){e.src!==this.props.src&&this.loadImage()}},{key:"componentWillUnmount",value:function(){this.image.removeEventListener("load",this.handleLoad)}},{key:"loadImage",value:function(){this.props.src?(this.image=new window.Image,this.image.src=this.props.src,this.image.addEventListener("load",this.handleLoad),this.image.addEventListener("error",this.handleError)):this.image=void 0}},{key:"render",value:function(){var e=this;return void 0!==this.state.error?Object(o.jsx)(W.Text,{text:this.state.error,fontSize:20,fill:"red"}):Object(o.jsx)(W.Image,{x:0,y:0,image:this.state.image,scaleX:this.props.scale,scaleY:this.props.scale,ref:function(t){e.imageNode=t}})}}]),n}(c.a.Component),N=(n(61),n(71)),B=n.n(N),V=h.a.create({baseURL:"/zones-data/v1/"});function A(){return(A=Object(b.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=8;break}return e.next=3,V.get("".concat(t,"/zones-v1.json"));case 3:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 8:return e.abrupt("return",void 0);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function F(e){var t={};return e.map((function(e){return t[e.zone]=e})),t}var G=function(e){var t=Object(a.useState)({zones:[],stats:F(e.stats)}),n=Object(p.a)(t,2),c=n[0],r=n[1];Object(a.useEffect)((function(){i()}),[e.location]),Object(a.useEffect)((function(){r(Object(f.a)(Object(f.a)({},c),{},{stats:F(e.stats)}))}),[e.stats]);var i=function(){(function(e){return A.apply(this,arguments)})(e.location).then((function(t){console.log(t),r({zones:t.zones,stats:F(e.stats)})})).catch((function(e){console.log("ERROR:",e),r({zones:[]})}))},s=function(t){return t*e.scale},l=function(t){return t/e.scale},u=function(e){return e.polygon.map((function(e){var t=Object(p.a)(e,2),n=t[0],o=t[1];return[s(n),s(o)]})).flat()},d=function(e){if(c.stats){var t=c.stats[e];return t?"".concat(e," ").concat(t.last_detected_cars,"/").concat(t.max_detected_cars):e}},b=function(e){for(var t=e.polygon,n=[],o=0;o<t.length;o++){var a=Object(p.a)(t[o],2),c=a[0],r=a[1];n[o]={x:c,y:r,i:o}}return console.log("ppoints:",n),n},m=function(e,t,n,o){for(var a=[],r=0;r<c.zones.length;r++){var i=c.zones[r];i.name===e&&(i.polygon[t]=[n,o],i.modified=!0),a[r]=i}return a},h=function(e,t){!function(e,t){var n=window.URL||window.webkitURL||window,o=new Blob([t]);if("msSaveBlob"in navigator)navigator.msSaveBlob(o,e);else{if(!("download"in HTMLAnchorElement.prototype))throw new Error("Neither a[download] nor msSaveBlob is available");var a=document.createElementNS("http://www.w3.org/1999/xhtml","a");a.href=n.createObjectURL(o),a.download=e,function(e){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}(a)}}(e,t)};return c.zones.map((function(t){return Object(o.jsxs)(W.Group,{x:0,y:0,children:[Object(o.jsx)(W.Text,{text:d(t.name),x:3+t.polygon[0][0]*e.scale,y:t.polygon[0][1]*e.scale,fontSize:10,fill:e.color}),Object(o.jsx)(W.Line,{points:u(t),stroke:t.modified?e.modifiedColor:e.color,strokeWidth:1,closed:!0}),b(t).map((function(n){var a=n.x,i=n.y,u=n.i;return Object(o.jsx)(W.Circle,{x:s(a),y:s(i),radius:5,fill:t.modified?e.modifiedColor:e.color,draggable:!0,onDragStart:function(){r(Object(f.a)(Object(f.a)({},c),{},{isDragging:!0}))},onDragEnd:function(e){console.log(">>>>",e),r(Object(f.a)(Object(f.a)({},c),{},{isDragging:!1,zones:m(t.name,u,l(e.target.x()),l(e.target.y()))}))}},t.name+"-p-"+u)})),Object(o.jsx)(B.a,{handleKeys:["e"],onKeyEvent:function(t,n){return function(t){console.log("key:",t),"e"===t&&h("".concat(e.location,"/zones-v1.json"),JSON.stringify(c.zones))}(t)}})]},t.name)}))},H=function(e){Object(R.a)(n,e);var t=Object(U.a)(n);function n(){var e;Object(M.a)(this,n);for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return(e=t.call.apply(t,[this].concat(a))).state={detections:e.props.detections.map((function(t){return e.norm(t)}))},e}return Object(D.a)(n,[{key:"componentDidMount",value:function(){}},{key:"componentDidUpdate",value:function(e){var t=this;if(e.detections!==this.props.detections){var n=this.props.detections.map((function(e){return t.norm(e)}));this.setState({detections:n})}}},{key:"componentWillUnmount",value:function(){}},{key:"norm",value:function(e){return{object:e.object,confidence:parseFloat(e.measure_value),bbox:{x:parseInt(e.att_x)+parseInt(e.bbox_x)-parseInt(e.bbox_w)/2,y:parseInt(e.att_y)+parseInt(e.bbox_y)-parseInt(e.bbox_h)/2,width:parseInt(e.bbox_w),height:parseInt(e.bbox_h)}}}},{key:"scaled",value:function(e){return e*this.props.scale}},{key:"render",value:function(){var e=this;return this.state.detections.map((function(t){return Object(o.jsxs)(W.Group,{x:e.scaled(t.bbox.x),y:e.scaled(t.bbox.y),children:[Object(o.jsx)(W.Text,{text:t.object+" "+t.confidence.toFixed(2),x:3,fontSize:10,fill:e.props.color}),Object(o.jsx)(W.Rect,{width:e.scaled(t.bbox.width),height:e.scaled(t.bbox.height),stroke:e.props.color,strokeWidth:1})]},t.confidence)}))}}]),n}(c.a.Component),J=console.log;function K(){return(K=Object(b.a)(d.a.mark((function e(t){var n;return d.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j.get("view?location=".concat(t,"&image=yes&detections=yes"));case 2:return n=e.sent,console.log("response:",n),e.abrupt("return",n.data);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function X(){return Math.max(document.documentElement.clientWidth||0,window.innerWidth||0)}function Y(){return Math.max(document.documentElement.clientHeight||0,window.innerHeight||0)}function Z(e,t,n,o){if(e&&t&&n&&o){var a=e/n,c=t/o;return Math.min(a,c)}return.25}var $=function(){var e=Object(a.useState)({picSrc:void 0,firstPic:!0,vw:X(),vh:Y(),scale:Z(X(),Y()),detections:[],stats:[]}),t=Object(p.a)(e,2),n=t[0],c=t[1],r=Object(l.f)(),i=r.location,s=r.camera,u=function(e,t){var n=function(e){var t=e/60;return Math.max(0,Math.min(100,100-25*t))}(((new Date).getTime()-new Date(t).getTime())/1e3-65);return{backgroundImage:"url(".concat(e,")"),backgroundColor:"#282c34",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundAttachment:"fixed",backgroundPosition:"center",filter:"blur(".concat(0,"px) saturate(").concat(n,"%)")}},d=function(){(function(e){return K.apply(this,arguments)})(i+"/"+s).then((function(e){J(e);var t=e.duration?e.duration:60,o=e.image.url,a=e.frameTime,r=u(o,a),l=Object(f.a)(Object(f.a)({},n),{},{picSrc:o,firstPic:!1,duration:t,frameTime:a,style:r,detections:e.detections||[],stats:e.stats||[]});c(l),document.title=e.message+", parking at ".concat(i,"/").concat(s," ").concat(new Date(a))})).catch((function(e){console.log(e);var t=u(n.picSrc,n.frameTime),o=n.retries?n.retries+1:0;c(Object(f.a)(Object(f.a)({},n),{},{picSrc:n.picSrc,firstPic:!1,duration:30,style:t,retries:o,detections:[],stats:[]})),document.title="Retrying (".concat(o,")")+(n.frameTime?" from ".concat(n.frameTime," ..."):"...")}))};return i===n.location&&s===n.camera||c(Object(f.a)(Object(f.a)({},n),{},{firstPic:!0,location:i,camera:s})),Object(a.useEffect)((function(){var e=n.firstPic?0:n.duration;console.log("Timeout till renew:",e);var t=setTimeout(d,1e3*e);return function(){console.log("Stopping renewal of CamView"),clearTimeout(t)}})),Object(o.jsx)("div",{className:"CamView",children:Object(o.jsx)("div",{className:"CamView-header",children:Object(o.jsxs)(W.Stage,{width:n.vw,height:n.vh,style:{backgroundColor:"dimgray"},children:[Object(o.jsx)(W.Layer,{children:Object(o.jsx)(P,{src:n.picSrc,scale:n.scale,onLoadImage:function(e){return function(e){var t=X(),o=Y(),a=e?e.width:n.iw,r=e?e.height:n.ih,i=Z(t,o,a,r);if(a!==n.iw||r!==n.ih||t!==n.vw||o!==n.vh||i!==n.scale){var s={vw:t,vh:o,iw:a,ih:r,scale:i};console.log("[!] New state changes:",s),c(Object(f.a)(Object(f.a)({},n),s))}}(e)}})}),Object(o.jsx)(W.Layer,{children:Object(o.jsx)(G,{location:i+"/"+s,stats:n.stats,scale:n.scale,color:"magenta",modifiedColor:"red"})}),Object(o.jsx)(W.Layer,{children:Object(o.jsx)(H,{detections:n.detections,scale:n.scale,color:"yellow"})}),Object(o.jsxs)(W.Layer,{children:[Object(o.jsx)(W.Group,{x:n.vw-200,y:3,children:Object(o.jsx)(W.Text,{text:"Info:\n  location: ".concat(i,"\n  camera: ").concat(s,"\n  frame time: ").concat(n.frameTime,"\n  detections: ").concat(n.detections.length,"\n  zones:\n    ")+n.stats.map((function(e){return"".concat(e.zone,": ").concat(e.last_detected_cars,"/").concat(e.max_detected_cars," [max of ").concat(e.period_for_max,"]")})).join("\n    "),fontSize:10,fill:"magenta"})}),Object(o.jsx)(W.Group,{x:n.vw-180,y:n.vh-100,children:Object(o.jsx)(W.Text,{text:"Config:\n  screen: ".concat(n.vw,"x").concat(n.vh,"\n  scale: ").concat(n.scale,"\n\nKeys:\n  'e': export zones\n\nHelp:\n  - Move zone edge points with mouse\n"),fontSize:10,fill:"black"})})]})]})})})};var q=function(){return Object(o.jsxs)("div",{children:[Object(o.jsx)("h1",{children:"VideoParking"}),Object(o.jsxs)(s.a,{children:[Object(o.jsx)("nav",{children:Object(o.jsxs)("ul",{children:[Object(o.jsx)("li",{children:Object(o.jsx)(s.b,{to:"/map/52.371809,5.188753",children:"Map"})}),Object(o.jsx)("li",{children:Object(o.jsx)(s.b,{to:"/cam/8f38301f7f70d7d1/1",children:"Camera 8f38301f7f70d7d1/1"})}),Object(o.jsx)("li",{children:Object(o.jsx)(s.b,{to:"/cam/a07345b2737af5f/1",children:"Camera a07345b2737af5f/1"})})]})}),Object(o.jsxs)(l.c,{children:[Object(o.jsx)(l.a,{path:"/map/:latLng",children:Object(o.jsx)(C,{})}),Object(o.jsx)(l.a,{path:"/cam/:location/:camera/:zone",children:Object(o.jsx)($,{})}),Object(o.jsx)(l.a,{path:"/cam/:location/:camera",children:Object(o.jsx)($,{})}),Object(o.jsx)(l.a,{path:"/",children:Object(o.jsx)(C,{})})]})]})]})};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(Object(o.jsx)(c.a.StrictMode,{children:Object(o.jsx)(q,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},76:function(e,t,n){},77:function(e,t,n){},80:function(e,t,n){}},[[147,1,2]]]);
//# sourceMappingURL=main.a66c541f.chunk.js.map